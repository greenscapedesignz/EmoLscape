<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenscape Designz Happiness Index‚Ñ¢ - AI Powered</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0"
        }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Merriweather:ital,wght@0,400;0,700;0,900;1,400&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; } /* Very light green bg */
       .font-serif { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
       .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
       .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

       /* Markdown Styles for AI Response */
       .prose-sm p { margin-bottom: 0.75em; }
       .prose-sm ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
       .prose-sm strong { font-weight: 700; color: #166534; }
       .prose-sm h3 { font-weight: 800; color: #064e3b; margin-top: 1em; margin-bottom: 0.5em; }
       .prose-sm table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
       .prose-sm th, .prose-sm td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
       .prose-sm th { background-color: #f0fdf4; color: #166534; }
        
        @media print {
           .no-print { display: none!important; }
           .print-only { display: block!important; }
            body { background-color: white; }
           .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>
    <div id="root" class="flex items-center justify-center min-h-screen">
        <div class="text-center text-green-800">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
            <p class="font-bold">Loading Greenscape Designz Happiness Index‚Ñ¢ (AI Edition)...</p>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Leaf, Wind, Bird, Footprints, Heart, Users, Shield, Droplets, 
            BarChart3, Info, ChevronDown, ChevronUp, Save, Download, 
            RotateCcw, Target, Settings, Share2, Mail, Printer,
            Thermometer, Mic, Eye, Activity, Ruler, Zap, PenTool, Sparkles, MessageSquare, X, Bot, Flower2, Send, Copy
        } from 'lucide-react';

        // --- GEMINI API CONFIG ---
        // API Key configured for Greenscape Designz
        const apiKey = "AIzaSyAxZNYUPasJ5YR6EHyjuwG1OR3Wa97Ld7U"; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const callGemini = async (prompt, systemInstruction) => {
            if (!apiKey) {
                return "‚ö†Ô∏è API Key Missing.";
            }
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    }
                );
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Sorry, I encountered an error connecting to the AI service. Please check your internet connection.";
            }
        };

        // --- DATA STRUCTURES ---

        const GDHI_PILLARS = [
            { 
                id: 'SR', name: 'Sensory Richness', hex: '#ef4444', icon: <Eye />, 
                desc: 'Engagement through color, texture, sound, and scent.',
                subs: [
                    { name: 'Color Palette', desc: 'Visual variety & harmony.', ranges: ['Monochromatic', 'Limited', 'Harmonious', 'Masterpiece'],
                      audit: { expertise: 'Horticulturalist / Designer', tool: 'Camera, Color Wheel, Planting Plan', method: 'Audit flowering calendar. Count distinct color events per season. Target: 3+ colors in bloom simultaneously.' } },
                    { name: 'Texture', desc: 'Tactile diversity.', ranges: ['Flat', 'Basic', 'Rich', 'Symphony'],
                      audit: { expertise: 'Landscape Architect', tool: 'Tactile Audit Kit (Material Samples)', method: 'Touch test of hardscape & softscape. Count distinct textures within reach (0-2m height).' } },
                    { name: 'Acoustic', desc: 'Natural sounds vs noise.', ranges: ['Noisy', 'Neutral', 'Natural', 'Sanctuary'],
                      audit: { expertise: 'Acoustic Consultant', tool: 'Decibel Meter (Class 2)', method: 'Measure LAeq (avg noise) over 15 mins. Check if bird/water sounds mask traffic noise.' } },
                    { name: 'Seasonality', desc: 'Year-round interest.', ranges: ['Static', '2-Season', '4-Season', 'Ever-Changing'],
                      audit: { expertise: 'Horticulturalist', tool: 'Phenology Chart', method: 'Review planting schedule. Verify distinct visual peaks (flower/foliage) in all 4 seasons.' } }
                ] 
            },
            { 
                id: 'MC', name: 'Microclimate Comfort', hex: '#3b82f6', icon: <Thermometer />, 
                desc: 'Thermal comfort, shade, airflow.',
                subs: [
                    { name: 'Shade', desc: 'Canopy/Structures.', ranges: ['Exposed', 'Partial', 'Effective', 'Optimal'],
                      audit: { expertise: 'Env. Engineer', tool: 'Sun Path App / Pyranometer', method: 'Measure shade % on primary paths at 12pm-2pm Summer Solstice. Target: >60% coverage.' } },
                    { name: 'Airflow', desc: 'Breeze flow.', ranges: ['Stagnant', 'Inconsistent', 'Natural', 'Perfect Flow'],
                      audit: { expertise: 'MEP Engineer', tool: 'Anemometer', method: 'Measure wind speed in seating zones. Target: 0.5-1.5 m/s (pleasant breeze).' } },
                    { name: 'Heat Island', desc: 'Cool materials.', ranges: ['Hot', 'Standard', 'Reflective', 'Zero Heat'],
                      audit: { expertise: 'Sustainability Consultant', tool: 'Infrared Thermometer', method: 'Measure surface temp of paving vs. ambient air. Target: < 5¬∞C delta.' } },
                    { name: 'Human Comfort', desc: 'Thermal safety.', ranges: ['Stress', 'Tolerable', 'Comfort', 'Utopia'],
                      audit: { expertise: 'Biometeorologist', tool: 'UTCI Calculator / Weather Station', method: 'Calculate Universal Thermal Climate Index based on temp, humidity, wind.' } }
                ] 
            },
            { 
                id: 'BC', name: 'Biodiversity', hex: '#10b981', icon: <Bird />, 
                desc: 'Ecological richness & habitat.',
                subs: [
                    { name: 'Native Spp', desc: 'Indigenous plants.', ranges: ['Exotic', 'Mixed', 'Mostly Native', '100% Native'],
                      audit: { expertise: 'Ecologist', tool: 'Species Checklist / Floristic Inventory', method: 'Count total species vs. native species. Target: >70% Native.' } },
                    { name: 'Habitat Layers', desc: 'Nesting/feeding.', ranges: ['Sterile', 'Basic', 'Complex', 'Thriving'],
                      audit: { expertise: 'Ecologist', tool: 'Visual Survey', method: 'Verify presence of 5 layers: Groundcover, shrub, understory, canopy, emergent.' } },
                    { name: 'Pollinators', desc: 'Bee/butterfly support.', ranges: ['None', 'Occasional', 'Friendly', 'Haven'],
                      audit: { expertise: 'Entomologist / Naturalist', tool: 'Pollinator Count Log', method: '15-min observation in 3 zones. Count distinct pollinator visits.' } },
                    { name: 'Bio-filtration', desc: 'Water cleansing.', ranges: ['Runoff', 'Basic', 'Managed', 'Zero Discharge'],
                      audit: { expertise: 'Hydrologist', tool: 'Infiltration Ring', method: 'Test permeability of swales. Verify no standing water >24hrs after rain.' } }
                ] 
            },
            { 
                id: 'MF', name: 'Movement Flow', hex: '#8b5cf6', icon: <Footprints />, 
                desc: 'Circulation & accessibility.',
                subs: [
                    { name: 'Intuitive', desc: 'Logical paths.', ranges: ['Maze', 'Signage Needed', 'Clear', 'Intuitive'],
                      audit: { expertise: 'Urban Planner', tool: 'Cognitive Map Survey', method: 'Ask new users to find a destination without signs. Measure success rate.' } },
                    { name: 'Access', desc: 'Universal (ADA).', ranges: ['Barriers', 'Basic', 'Accessible', 'Inclusive'],
                      audit: { expertise: 'Access Consultant', tool: 'Digital Level (Inclinometer)', method: 'Measure ramp slopes (<1:12) and path widths (>1.5m).' } },
                    { name: 'Desire Lines', desc: 'Path adherence.', ranges: ['Chaos', 'Worn Paths', 'Effective', 'Seamless'],
                      audit: { expertise: 'Planner', tool: 'Drone/Visual Inspection', method: 'Check for worn grass (shortcuts). Indicates design failure.' } },
                    { name: 'Zoning', desc: 'Activity separation.', ranges: ['Conflict', 'Mixed', 'Defined', 'Harmonious'],
                      audit: { expertise: 'Landscape Architect', tool: 'Activity Mapping', method: 'Observe conflict points (e.g., cyclists hitting pedestrians).' } }
                ] 
            },
            { 
                id: 'RV', name: 'Restorative Value', hex: '#20c997', icon: <Heart />, 
                desc: 'Stress reduction & calm.',
                subs: [
                    { name: 'Tranquility', desc: 'Visual calm.', ranges: ['Chaotic', 'Average', 'Serene', 'Meditative'],
                      audit: { expertise: 'Env. Psychologist', tool: 'Perceived Restorativeness Scale (PRS)', method: 'User survey regarding "Being Away" and "Fascination".' } },
                    { name: 'Refuge', desc: 'Private spaces.', ranges: ['Exposed', 'Semi-Private', 'Safe', 'Sanctuary'],
                      audit: { expertise: 'Designer', tool: 'Prospect-Refuge Map', method: 'Identify seating with solid back protection and open views.' } },
                    { name: 'Immersion', desc: 'Nature dosing.', ranges: ['Urban', 'Garden', 'Immersive', 'Deep Nature'],
                      audit: { expertise: 'Wellness Consultant', tool: 'Green View Index', method: 'Photo analysis: % of visual field filled by vegetation.' } },
                    { name: 'Sound Masking', desc: 'White noise.', ranges: ['Traffic', 'Audible', 'Masked', 'Nature Only'],
                      audit: { expertise: 'Acoustic Engineer', tool: 'Audio Spectrum Analyzer', method: 'Verify if water feature frequency masks conversation/traffic.' } }
                ] 
            },
            { 
                id: 'SC', name: 'Social Cohesion', hex: '#f97316', icon: <Users />, 
                desc: 'Interaction & gathering.',
                subs: [
                    { name: 'Gathering', desc: 'Group spaces.', ranges: ['Isolation', 'Small Groups', 'Hub', 'Magnet'],
                      audit: { expertise: 'Sociologist', tool: 'Behavioral Observation Log', method: 'Count group sizes. Are people staying >15 mins?' } },
                    { name: 'Flexibility', desc: 'Adaptable seating.', ranges: ['Rigid', 'Semi-Fixed', 'Adaptable', 'Configurable'],
                      audit: { expertise: 'Ergonomist', tool: 'Inventory Check', method: 'Count movable chairs vs fixed benches. Higher movable ratio = higher score.' } },
                    { name: 'Play Value', desc: 'Recreation.', ranges: ['Boring', 'Standard', 'Engaging', 'World-Class'],
                      audit: { expertise: 'Play Inspector', tool: 'Risk/Benefit Assessment', method: 'Evaluate play types: Active, Sensory, Imaginative, Social.' } },
                    { name: 'Intergenerational', desc: 'All-ages.', ranges: ['Segregated', 'Dual', 'Multi-Age', 'Inclusive'],
                      audit: { expertise: 'Gerontologist', tool: 'User Demographics Log', method: 'Observe if seniors and children share the same space comfortably.' } }
                ] 
            },
            { 
                id: 'ES', name: 'Emotional Safety', hex: '#ec4899', icon: <Shield />, 
                desc: 'CPTED & Security.',
                subs: [
                    { name: 'Visibility', desc: 'Sightlines.', ranges: ['Blind Spots', 'Obstructed', 'Clear', 'Total View'],
                      audit: { expertise: 'Security Consultant', tool: 'CPTED Audit Checklist', method: 'Walkthrough: Check for "ambush zones" or blocked sightlines.' } },
                    { name: 'Lighting', desc: 'Night safety.', ranges: ['Dark', 'Uneven', 'Warm', 'Perfect'],
                      audit: { expertise: 'Lighting Designer', tool: 'Lux Meter', method: 'Measure uniformity ratio (Min/Avg). Target > 0.4.' } },
                    { name: 'Perception', desc: 'Feeling safe.', ranges: ['Fearful', 'Cautious', 'Secure', 'Welcoming'],
                      audit: { expertise: 'Psychologist', tool: 'Night Walk Survey', method: 'Rate "fear of crime" at night vs day.' } },
                    { name: 'Enclosure', desc: 'Boundaries.', ranges: ['Leaky', 'Porous', 'Defined', 'Safe'],
                      audit: { expertise: 'Designer', tool: 'Boundary Mapping', method: 'Assess clarity of public vs private territory.' } }
                ] 
            },
            { 
                id: 'ER', name: 'Eco Resilience', hex: '#4f46e5', icon: <Leaf />, 
                desc: 'Water, soil & longevity.',
                subs: [
                    { name: 'Soil', desc: 'Health/Permeability.', ranges: ['Dead', 'Modified', 'Healthy', 'Living Sponge'],
                      audit: { expertise: 'Soil Scientist', tool: 'Chromatography / pH Meter', method: 'Test organic matter (>5%) and compaction levels.' } },
                    { name: 'Stormwater', desc: 'SuDS/Drainage.', ranges: ['Flooding', 'Piped', 'Managed', 'Total Capture'],
                      audit: { expertise: 'Civil Engineer', tool: 'Rainfall Simulation', method: 'Verify zero runoff from site during 1-year storm event.' } },
                    { name: 'Drought', desc: 'Water-wise.', ranges: ['High Use', 'Moderate', 'Water Wise', 'Xeric'],
                      audit: { expertise: 'Irrigation Specialist', tool: 'Water Bill Audit', method: 'Calculate liters/m2/year. Compare to baseline.' } },
                    { name: 'Maintenance', desc: 'Viability.', ranges: ['Fragile', 'Standard', 'Low Input', 'Robust'],
                      audit: { expertise: 'FM Manager', tool: 'Opex Budget Review', method: 'Analyze replacement costs and labor hours per year.' } }
                ] 
            },
            { 
                id: 'PM', name: 'Performance & Measurement', hex: '#0891b2', icon: <BarChart3 />, 
                desc: 'Validating the "Emotional ROI".',
                subs: [ 
                    { name: 'POE Protocol', desc: 'Post-Occupancy Eval.', ranges: ['None', 'Ad-hoc', 'Annual', 'Continuous'],
                      audit: { expertise: 'Researcher', tool: 'Audit Schedule', method: 'Verify existence of a formalized annual feedback loop.' } },
                    { name: 'SROI Value', desc: 'Social ROI.', ranges: ['Negative', 'Neutral', 'Positive', 'High Yield'],
                      audit: { expertise: 'Financial Analyst', tool: 'SROI Calculator', method: 'Calculate ratio of Social Value ($) to Investment ($).' } },
                    { name: 'Data-Driven', desc: 'Sensor/Tech usage.', ranges: ['Analog', 'Basic', 'Smart', 'AI-Integrated'],
                      audit: { expertise: 'Smart City Consultant', tool: 'Dashboard Check', method: 'Check for active soil/air/water sensors feeding real-time data.' } },
                    { name: 'User Satisfaction', desc: 'Happiness metric.', ranges: ['Unhappy', 'Neutral', 'Happy', 'Delighted'],
                      audit: { expertise: 'Community Manager', tool: 'NPS Survey', method: 'Aggregated Net Promoter Score from users (>70 is excellent).' } }
                ] 
            }
        ];

        const SCORE_TIERS = [
            { name: 'Platinum', min: 9.0, color: '#ccfbf1', border: '#14b8a6', text: '#0f766e', badge: 'Regenerative & Iconic' },
            { name: 'Gold', min: 7.5, color: '#fef3c7', border: '#f59e0b', text: '#b45309', badge: 'High Performance' },
            { name: 'Silver', min: 5.0, color: '#f3f4f6', border: '#9ca3af', text: '#374151', badge: 'Standard Compliance' },
            { name: 'Needs Improvement', min: 0.0, color: '#fee2e2', border: '#ef4444', text: '#b91c1c', badge: 'Remediation Required' }
        ];

        // --- COMPONENTS ---

        const Logo = () => (
            <div className="flex flex-col items-center justify-center font-serif text-green-900">
                <div className="relative w-14 h-14 mb-1">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                        <path d="M50 95C74.8528 95 95 74.8528 95 50C95 25.1472 74.8528 5 50 5C25.1472 5 5 25.1472 5 50C5 74.8528 25.1472 95 50 95Z" stroke="#166534" strokeWidth="4"/>
                        <path d="M50 20C50 20 70 50 70 70C70 81.0457 61.0457 90 50 90C38.9543 90 30 81.0457 30 70C30 50 50 20 50 20Z" fill="#15803d"/>
                        <path d="M50 35C50 35 60 55 60 65" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                        <path d="M50 35C50 35 40 55 40 65" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                    </svg>
                </div>
                <h1 className="text-xl font-black tracking-tight leading-none">EmoL'scape</h1>
            </div>
        );

        const IntroCard = () => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-green-100 mb-8 overflow-hidden transition-all duration-300">
                    <div className="bg-green-50 p-4 flex justify-between items-center cursor-pointer hover:bg-green-100" onClick={() => setIsOpen(!isOpen)}>
                        <div className="flex items-center gap-3">
                            <Info className="w-5 h-5 text-green-700" />
                            <h2 className="font-bold text-green-900">Why GDHI? (About the Tool)</h2>
                        </div>
                        {isOpen ? <ChevronUp className="w-5 h-5 text-green-600"/> : <ChevronDown className="w-5 h-5 text-green-600"/>}
                    </div>
                    {isOpen && (
                        <div className="p-6 text-sm text-gray-700 animate-fade-in">
                            <p className="mb-4 text-lg font-medium text-green-800 italic">
                                "Measuring and auditing the 'emotional ROI' of landscapes‚Äîmoving beyond just 'looking green' to 'feeling great' and to understand which part needs to be 'fixed'."
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                    <strong className="block text-green-700 text-xs uppercase mb-1">Diagnosis</strong>
                                    Identify invisible failures (heat pockets, noise pollution) that lower asset value.
                                </div>
                                <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                    <strong className="block text-green-700 text-xs uppercase mb-1">Prescription</strong>
                                    Use the "Audit Protocols" to determine exactly what tools and expertise are needed to fix issues.
                                </div>
                                <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                                    <strong className="block text-green-700 text-xs uppercase mb-1">Certification</strong>
                                    Achieve Platinum or Gold status to validate your landscape as a high-performance asset.
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AIConsultantModal = ({ onClose, projectData, results, scores }) => {
            const [activeTab, setActiveTab] = useState('remediation'); // 'remediation', 'plants', 'email', 'chat'
            const [isLoading, setIsLoading] = useState(false);
            const [response, setResponse] = useState(null);
            
            // Separate responses for each feature to persist state when switching tabs
            const [remediationResponse, setRemediationResponse] = useState(null);
            const [plantResponse, setPlantResponse] = useState(null);
            const [emailResponse, setEmailResponse] = useState(null);

            const [chatInput, setChatInput] = useState("");
            const [chatHistory, setChatHistory] = useState([
                { role: 'system', text: "Hello! I'm EmoL, your AI Landscape Consultant. I can help you understand the GDHI framework or suggest improvements for your site. How can I assist you today?" }
            ]);

            const generateContent = async (type) => {
                setIsLoading(true);
                let prompt = '';
                let systemInstruction = '';

                if (type === 'remediation') {
                    const lowestPillars = Object.entries(results.pillarAvgs)
                        .sort(([,a], [,b]) => a - b)
                        .slice(0, 3)
                        .map(([id]) => GDHI_PILLARS.find(p => p.id === id)?.name);
                    
                    prompt = `Project: ${projectData.siteName} (${projectData.location}). Tier: ${results.tier.name} (Score: ${results.overall.toFixed(1)}). Lowest Pillars: ${lowestPillars.join(', ')}. Provide a "Renovation Roadmap" with 3 actionable design interventions for EACH lowest pillar. Expert landscape architect tone. Markdown format.`;
                    systemInstruction = "You are EmoL, an expert Landscape Architect specialized in GDHI audits.";
                } else if (type === 'plants') {
                    prompt = `Suggest a specific landscape plant palette for ${projectData.location} considering a Biodiversity score of ${results.pillarAvgs['BC']?.toFixed(1) || 'N/A'} and Sensory Richness score of ${results.pillarAvgs['SR']?.toFixed(1) || 'N/A'}. List 3 Trees, 3 Shrubs, and 3 Groundcovers/Accents that thrive in this region and boost these scores. Include their sensory/ecological benefits. Format as a clean table.`;
                    systemInstruction = "You are an expert Horticulturalist and Ecologist.";
                } else if (type === 'email') {
                    prompt = `Draft a formal, persuasive email to the stakeholders of ${projectData.siteName}. 
                    The audit score is ${results.overall.toFixed(1)} (${results.tier.name}). 
                    Summarize key strengths and weak points based on the GDHI audit. 
                    Propose a meeting to discuss the Remediation Roadmap.
                    
                    Sign off exactly as follows:
                    Anirban Pal
                    Landscape Architect
                    Greenscape Designz
                    anirban.pal@greenscapedesignz.in
                    
                    Keep it professional and under 200 words.`;
                    systemInstruction = "You are Anirban Pal from Greenscape Designz, drafting client communications.";
                }

                const result = await callGemini(prompt, systemInstruction);
                
                if (type === 'remediation') setRemediationResponse(result);
                if (type === 'plants') setPlantResponse(result);
                if (type === 'email') setEmailResponse(result);
                
                setIsLoading(false);
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;

                const userMsg = { role: 'user', text: chatInput };
                setChatHistory(prev => [...prev, userMsg]);
                setChatInput("");
                setIsLoading(true);

                const context = `Context: Project ${projectData.siteName} in ${projectData.location}. Score: ${results.overall.toFixed(1)}.`;
                const systemInstruction = `You are EmoL, a friendly AI Landscape Consultant. Context: ${context}`;
                
                const result = await callGemini(chatInput, systemInstruction);
                
                setChatHistory(prev => [...prev, { role: 'system', text: result }]);
                setIsLoading(false);
            };

            // Trigger generation on tab switch if empty
            useEffect(() => {
                if (activeTab === 'remediation' && !remediationResponse) generateContent('remediation');
                if (activeTab === 'plants' && !plantResponse) generateContent('plants');
                if (activeTab === 'email' && !emailResponse) generateContent('email');
            }, [activeTab]);

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                alert("Copied to clipboard!");
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in">
                        {/* Header */}
                        <div className="bg-green-900 text-white p-4 flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-2">
                                <Sparkles className="w-6 h-6 text-yellow-300" />
                                <h2 className="text-xl font-bold">AI Landscape Consultant</h2>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-green-800 rounded-full"><X className="w-5 h-5"/></button>
                        </div>

                        {/* Tabs */}
                        <div className="flex border-b border-gray-200 shrink-0 bg-white overflow-x-auto">
                            {[
                                { id: 'remediation', icon: <PenTool className="w-4 h-4"/>, label: 'Roadmap' },
                                { id: 'plants', icon: <Flower2 className="w-4 h-4"/>, label: 'Plant Palette' },
                                { id: 'email', icon: <Mail className="w-4 h-4"/>, label: 'Draft Email' },
                                { id: 'chat', icon: <MessageSquare className="w-4 h-4"/>, label: 'Ask EmoL' }
                            ].map(tab => (
                                <button 
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-1 py-4 px-4 font-bold text-sm flex items-center justify-center gap-2 whitespace-nowrap transition-colors ${activeTab === tab.id ? 'border-b-4 border-green-600 text-green-800 bg-green-50' : 'text-gray-500 hover:bg-gray-50'}`}
                                >
                                    {tab.icon} {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 overflow-y-auto p-6 bg-gray-50">
                            {isLoading && (
                                <div className="flex flex-col items-center justify-center h-64 text-green-800">
                                    <Sparkles className="w-12 h-12 mb-4 animate-spin text-yellow-500"/>
                                    <p className="font-bold text-lg animate-pulse">Consulting EmoL AI...</p>
                                    <p className="text-sm opacity-70">Thinking about {projectData.siteName}...</p>
                                </div>
                            )}

                            {!isLoading && activeTab === 'remediation' && remediationResponse && (
                                <div className="bg-white p-8 rounded-xl shadow-sm border border-green-100 prose-sm text-gray-700">
                                    <div dangerouslySetInnerHTML={{ __html: remediationResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>') }} />
                                    <button onClick={() => generateContent('remediation')} className="mt-8 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-bold text-gray-600 flex items-center">
                                        <RotateCcw className="w-3 h-3 mr-2"/> Regenerate
                                    </button>
                                </div>
                            )}

                            {!isLoading && activeTab === 'plants' && plantResponse && (
                                <div className="bg-white p-8 rounded-xl shadow-sm border border-green-100 prose-sm text-gray-700">
                                    <h3 className="text-2xl font-bold text-green-900 mb-4 flex items-center"><Flower2 className="w-6 h-6 mr-2 text-pink-500"/> Curated Plant Palette</h3>
                                    <div dangerouslySetInnerHTML={{ __html: plantResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>') }} />
                                    <button onClick={() => generateContent('plants')} className="mt-8 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-bold text-gray-600 flex items-center">
                                        <RotateCcw className="w-3 h-3 mr-2"/> Suggest Alternatives
                                    </button>
                                </div>
                            )}

                            {!isLoading && activeTab === 'email' && emailResponse && (
                                <div className="bg-white p-8 rounded-xl shadow-sm border border-green-100">
                                    <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Mail className="w-5 h-5 mr-2 text-blue-500"/> Draft Client Email</h3>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-700 font-mono whitespace-pre-wrap mb-4">
                                        {emailResponse}
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => copyToClipboard(emailResponse)} className="px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg text-sm font-bold flex items-center">
                                            <Copy className="w-4 h-4 mr-2"/> Copy Text
                                        </button>
                                        <button onClick={() => generateContent('email')} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-bold text-gray-700 flex items-center">
                                            <RotateCcw className="w-4 h-4 mr-2"/> Rewrite
                                        </button>
                                    </div>
                                </div>
                            )}

                            {!isLoading && activeTab === 'chat' && (
                                <div className="flex flex-col h-full">
                                    <div className="flex-1 overflow-y-auto space-y-4 mb-4 pr-2">
                                        {chatHistory.map((msg, i) => (
                                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-green-600 text-white rounded-br-none' : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none shadow-sm'}`}>
                                                    {msg.role === 'system' && <Bot className="w-4 h-4 mb-1 text-green-600"/>}
                                                    {msg.text}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <form onSubmit={handleChatSubmit} className="relative mt-auto">
                                        <input 
                                            type="text" 
                                            value={chatInput}
                                            onChange={(e) => setChatInput(e.target.value)}
                                            placeholder="Ask EmoL anything..."
                                            className="w-full p-4 pr-12 rounded-xl border border-gray-300 focus:ring-2 focus:ring-green-500 outline-none shadow-sm"
                                        />
                                        <button type="submit" className="absolute right-2 top-2 p-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                            <Send className="w-4 h-4"/>
                                        </button>
                                    </form>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Slider = ({ sub, val, onChange }) => {
            const [showAudit, setShowAudit] = useState(false);
            
            const getColor = (s) => {
                if (s <= 3) return 'bg-red-500';
                if (s <= 6) return 'bg-yellow-400';
                if (s < 9) return 'bg-green-500';
                return 'bg-emerald-600';
            };

            const getLabel = (s) => {
                if (s <= 3) return sub.ranges[0];
                if (s <= 6) return sub.ranges[1];
                if (s < 9) return sub.ranges[2];
                return sub.ranges[3];
            };

            return (
                <div className="mb-6 last:mb-0">
                    <div className="flex justify-between items-end mb-2">
                        <div>
                            <div className="font-bold text-gray-800 text-sm">{sub.name}</div>
                            <div className="text-xs text-gray-500">{sub.desc}</div>
                        </div>
                        <div className="text-2xl font-black text-gray-800 tabular-nums">{val.toFixed(1)}</div>
                    </div>
                    
                    {/* Slider Track */}
                    <div className="relative h-3 bg-gray-200 rounded-full mb-2">
                        <div className={`absolute top-0 left-0 h-full rounded-full transition-all duration-300 opacity-80 ${getColor(val)}`} style={{ width: `${val * 10}%` }}></div>
                        <input type="range" min="0" max="10" step="0.1" value={val} onChange={(e) => onChange(parseFloat(e.target.value))} 
                            className="absolute top-[-5px] left-0 w-full h-6 opacity-0 cursor-pointer" />
                    </div>
                    
                    <div className="flex justify-between items-center text-[10px] uppercase font-bold tracking-wider mb-2">
                        <span className="text-gray-400">Score 0</span>
                        <span style={{ color: val <= 3 ? '#ef4444' : val <= 6 ? '#eab308' : '#22c55e' }}>{getLabel(val)}</span>
                        <span className="text-gray-400">Score 10</span>
                    </div>

                    {/* Audit Details Toggle */}
                    <button onClick={() => setShowAudit(!showAudit)} className="text-[10px] flex items-center text-blue-600 hover:underline font-semibold bg-blue-50 px-2 py-1 rounded">
                        {showAudit ? <ChevronUp className="w-3 h-3 mr-1"/> : <Activity className="w-3 h-3 mr-1"/>}
                        {showAudit ? 'Hide Audit Protocol' : 'Show Audit Protocol'}
                    </button>

                    {/* Audit Details Content */}
                    {showAudit && (
                        <div className="mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs text-slate-700 animate-fade-in">
                            <div className="grid grid-cols-[80px_1fr] gap-2 mb-1">
                                <span className="font-bold text-slate-900 flex items-center"><Users className="w-3 h-3 mr-1"/> Expert:</span>
                                <span>{sub.audit.expertise}</span>
                            </div>
                            <div className="grid grid-cols-[80px_1fr] gap-2 mb-1">
                                <span className="font-bold text-slate-900 flex items-center"><Ruler className="w-3 h-3 mr-1"/> Tool:</span>
                                <span>{sub.audit.tool}</span>
                            </div>
                            <div className="grid grid-cols-[80px_1fr] gap-2">
                                <span className="font-bold text-slate-900 flex items-center"><Zap className="w-3 h-3 mr-1"/> Method:</span>
                                <span>{sub.audit.method}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CertificateModal = ({ data, results, onClose, pillars }) => {
            return (
                <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 print:p-0 print:bg-white print:static">
                    <div className="bg-white w-full max-w-4xl p-8 rounded-none shadow-2xl relative print:shadow-none print:w-full">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200 no-print"><RotateCcw className="w-5 h-5"/></button>
                        
                        <div className="border-[12px] border-double p-8 h-full flex flex-col justify-between" style={{ borderColor: results.tier.border }}>
                            {/* Cert Header */}
                            <div className="text-center mb-6">
                                <Logo />
                                <h1 className="text-2xl font-black text-green-900 tracking-tight leading-none mb-1">Greenscape Designz Happiness Index‚Ñ¢</h1>
                                <p className="text-xs text-gray-400 uppercase tracking-widest">Official Certification</p>
                                
                                <h2 className="text-4xl font-serif font-black text-gray-900 mt-6 uppercase tracking-widest">{results.tier.name} Tier</h2>
                                <p className="text-sm font-bold text-gray-500 uppercase tracking-widest mt-2">{results.tier.badge}</p>
                            </div>

                            {/* Project Details */}
                            <div className="text-center mb-6">
                                <p className="italic text-gray-500 mb-2">This certifies that the landscape performance of</p>
                                <h3 className="text-3xl font-bold text-gray-900">{data.siteName || 'Project Name'}</h3>
                                <div className="text-gray-600 mt-2 text-sm flex flex-wrap justify-center gap-3">
                                    {data.location && <span>üìç {data.location}</span>}
                                    {data.projectType && <span>üè¢ {data.projectType}</span>}
                                    {data.siteSize && <span>üìê {data.siteSize}</span>}
                                    <span>üìÖ {data.date}</span>
                                </div>
                                {data.auditor && <p className="text-sm font-bold text-green-800 mt-2 uppercase tracking-wide">Audited By: {data.auditor}</p>}
                            </div>

                            {/* Scores */}
                            <div className="flex justify-center items-center gap-12 mb-8">
                                <div className="text-center">
                                    <div className="text-6xl font-black text-gray-900">{results.overall.toFixed(1)}</div>
                                    <div className="text-xs uppercase font-bold text-gray-400 tracking-wider">Global Index</div>
                                </div>
                                <div className="h-16 w-px bg-gray-200"></div>
                                <div className="text-center">
                                    <div className="text-6xl font-black" style={{ color: data.nps >= 9 ? '#16a34a' : data.nps >= 7 ? '#ca8a04' : '#dc2626' }}>{data.nps ?? '-'}</div>
                                    <div className="text-xs uppercase font-bold text-gray-400 tracking-wider">NPS Score</div>
                                </div>
                            </div>

                            {/* 9-Grid Pillar Breakdown */}
                            <div className="grid grid-cols-3 gap-2 mb-6">
                                {pillars.map(p => (
                                    <div key={p.id} className="border border-gray-100 p-2 flex justify-between items-center bg-gray-50">
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-400 scale-75">{p.icon}</span>
                                            <span className="text-[10px] font-bold uppercase text-gray-600">{p.name}</span>
                                        </div>
                                        <span className="font-bold text-sm" style={{ color: p.hex }}>{results.pillarAvgs[p.id].toFixed(1)}</span>
                                    </div>
                                ))}
                            </div>

                            {/* Footer */}
                            <div className="text-center border-t border-gray-200 pt-4">
                                <p className="font-bold text-green-800 text-sm uppercase">Remediation & Improvement</p>
                                <p className="text-xs text-gray-500 italic mt-1">"Contact Greenscape Designz (+91 88613 17426) for a detailed Renovation Roadmap."</p>
                                <p className="text-[10px] text-gray-300 mt-4 uppercase tracking-widest">System Generated via Greenscape Designz Happiness Index‚Ñ¢ Tool</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // State
            const [scores, setScores] = useState(() => {
                const init = {};
                GDHI_PILLARS.forEach(p => p.subs.forEach(s => init[`${p.id}_${s.name}`] = 5.0));
                return init;
            });
            const [projectData, setProjectData] = useState({ 
                siteName: 'My Landscape Project', // Defaulted to prevent errors
                location: '', auditor: '', projectType: '', siteSize: '',
                date: new Date().toLocaleDateString(), nps: null 
            });
            const [showCert, setShowCert] = useState(false);
            const [showAI, setShowAI] = useState(false);

            // Calculations
            const results = useMemo(() => {
                let grandTotal = 0;
                const pillarAvgs = {};
                GDHI_PILLARS.forEach(p => {
                    let pTotal = 0;
                    p.subs.forEach(s => pTotal += scores[`${p.id}_${s.name}`]);
                    const avg = pTotal / p.subs.length;
                    pillarAvgs[p.id] = avg;
                    grandTotal += avg;
                });
                const overall = grandTotal / GDHI_PILLARS.length;
                const tier = SCORE_TIERS.find(t => overall >= t.min) || SCORE_TIERS[3];
                return { overall, pillarAvgs, tier };
            }, [scores]);

            // Handlers
            const updateScore = (key, val) => setScores(prev => ({...prev, [key]: val }));
            
            // Sharing Logic
            const shareText = `I just audited ${projectData.siteName || 'a landscape'} using the EmOL'scape GDHI Tool! \n\nOverall Score: ${results.overall.toFixed(1)}/10 (${results.tier.name})\nNPS: ${projectData.nps ?? '-'}/10\n\nPerformance Summary:\n${GDHI_PILLARS.map(p => `${p.name}: ${results.pillarAvgs[p.id].toFixed(1)}`).join('\n')}`;
            
            const handleWhatsapp = () => window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
            const handleEmail = () => window.open(`mailto:?subject=GDHI Audit Report: ${projectData.siteName}&body=${encodeURIComponent(shareText)}`, '_blank');

            return (
                <div className="max-w-5xl mx-auto px-4 py-8 pb-32">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-green-200 pb-6 gap-6 no-print">
                        <div className="flex items-center gap-4">
                            <Logo />
                            <div className="hidden md:block w-px h-12 bg-green-200 mx-2"></div>
                            <div>
                                <h1 className="text-xl md:text-2xl font-black text-green-900 tracking-tight leading-tight">Greenscape Designz <br/>Happiness Index‚Ñ¢</h1>
                                <p className="text-sm text-gray-500 font-medium">The Official Audit Tool</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleWhatsapp} className="flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-full hover:bg-green-200 font-bold text-sm transition"><Share2 className="w-4 h-4 mr-2"/> WhatsApp</button>
                            <button onClick={handleEmail} className="flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-full hover:bg-blue-100 font-bold text-sm transition"><Mail className="w-4 h-4 mr-2"/> Email</button>
                            <button onClick={() => window.location.reload()} className="p-2 text-gray-400 hover:text-red-500 rounded-full"><RotateCcw className="w-5 h-5"/></button>
                        </div>
                    </div>

                    {/* Intro Card */}
                    <IntroCard />

                    {/* Dashboard */}
                    <div className="sticky top-2 z-40 bg-white/90 backdrop-blur-md shadow-lg rounded-2xl p-4 mb-8 border border-green-100 transition-all duration-300 no-print">
                        <div className="flex justify-between items-center">
                            <div>
                                <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Current Progress (Base: 0)</div>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-4xl font-black text-gray-900">{results.overall.toFixed(1)}</span>
                                    <span className="text-sm font-bold px-3 py-1 rounded-full uppercase" style={{ backgroundColor: results.tier.color, color: results.tier.text }}>{results.tier.name}</span>
                                </div>
                                <div className="text-[9px] text-gray-500 mt-1 font-medium tracking-wide flex gap-2">
                                    <span className="text-red-500">0-5.0: Needs Imp.</span> <span className="text-gray-300">|</span> 
                                    <span className="text-gray-500">5.0-7.5: Silver</span> <span className="text-gray-300">|</span> 
                                    <span className="text-yellow-600">7.5-9.0: Gold</span> <span className="text-gray-300">|</span> 
                                    <span className="text-teal-600">9.0-10: Platinum</span>
                                </div>
                            </div>
                            <div className="text-right flex gap-3">
                                <button 
                                    onClick={() => setShowAI(true)}
                                    className="px-4 py-3 rounded-xl font-bold text-white shadow-md flex items-center transition bg-purple-600 hover:bg-purple-700 animate-pulse-slow"
                                >
                                    <Sparkles className="w-4 h-4 mr-2" /> AI Consultant
                                </button>
                                <button 
                                    onClick={() => setShowCert(true)}
                                    className={`px-6 py-3 rounded-xl font-bold text-white shadow-md flex items-center transition bg-green-700 hover:bg-green-800`}
                                >
                                    <Download className="w-4 h-4 mr-2" /> Generate Certificate
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Pillars Grid */}
                    <div className="grid grid-cols-1 gap-8 no-print">
                        {GDHI_PILLARS.map(p => (
                            <div key={p.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-gray-50 to-white">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm" style={{ backgroundColor: p.hex }}>
                                            {p.icon}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-gray-900 text-lg">{p.name}</h3>
                                            <p className="text-xs text-gray-500">{p.desc}</p>
                                        </div>
                                    </div>
                                    <span className="text-2xl font-black text-gray-800">{results.pillarAvgs[p.id].toFixed(1)}</span>
                                </div>
                                <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {p.subs.map(sub => (
                                        <Slider key={sub.name} sub={sub} val={scores[`${p.id}_${sub.name}`]} onChange={(v) => updateScore(`${p.id}_${sub.name}`, v)} />
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* NPS Section */}
                    <div className="mt-12 bg-white p-8 rounded-2xl shadow-sm border border-gray-200 text-center no-print">
                        <div className="inline-block p-3 rounded-full bg-blue-50 text-blue-600 mb-4"><Heart className="w-6 h-6"/></div>
                        <h3 className="text-xl font-bold text-gray-900 mb-2">Net Promoter Score</h3>
                        <p className="text-gray-500 mb-6 italic">"How likely are you to recommend this landscape Audit tool to a friend or colleague?"</p>
                        <div className="flex justify-center gap-2 flex-wrap max-w-2xl mx-auto">
                            {[0,1,2,3,4,5,6,7,8,9,10].map(val => (
                                <button 
                                    key={val} 
                                    onClick={() => setProjectData(prev => ({...prev, nps: val}))}
                                    className={`w-10 h-10 rounded-full font-bold text-sm transition-all ${projectData.nps === val ? 'scale-110 shadow-lg ring-2 ring-offset-2' : 'hover:bg-gray-100 text-gray-400'}`}
                                    style={{ 
                                        backgroundColor: projectData.nps === val ? (val >= 9 ? '#22c55e' : val >= 7 ? '#eab308' : '#ef4444') : undefined,
                                        color: projectData.nps === val ? 'white' : undefined 
                                    }}
                                >
                                    {val}
                                </button>
                            ))}
                        </div>
                    </div>

                    {showAI && <AIConsultantModal onClose={() => setShowAI(false)} projectData={projectData} results={results} scores={scores} />}
                    {showCert && <CertificateModal data={projectData} results={results} pillars={GDHI_PILLARS} onClose={() => setShowCert(false)} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
